<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
	@font-face {
		font-family: "FontAwesome";
		src: url(../fonts/FontAwesome.ttf);
	}

	.webViewTitle::before {
		font-family: FontAwesome;
		content: "\f100";
	}

	.webViewTitle::after {
		font-family: FontAwesome;
		content: "\f101";
	}

	body {
		text-align: center;
	}

	.overlay {
		-webkit-user-select: none;
		border: 1px solid black;
		border-radius: 0px 10px 10px 10px;
		padding: 5px 10px;
	}

	#movepoint_overlay {
		-webkit-user-select: none;
		width: 40px;
		max-width: 40px;
		height: 20px;
		max-height: 20px;
		background-color: red;
		color: yellow;
		border: 1px solid black;
		border-radius: 0px 16px 16px 16px;
		text-align: center;
		vertical-align: middle;
    padding: 20px;
	}
  </style>

  <!-- <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css"> -->
  <link rel="stylesheet" href="openlayers/ol.css" type="text/css">

  <link rel="stylesheet" href="geolocation-style.css" type="text/css">

  <!-- <link rel="stylesheet" href="all.css" type="text/css"> -->
</head>
<body>
  <div class="webViewTitle" id="title">No expedition selected</div>
  <div id="map" class="map"></div>
  <div style="position: absolute;
    top: 0;
	  height: 30px;
	  left: 0;
	  right: 0;
    background-color: rgba(255,255,255,0.6);"
  >
    увеличение : <code id="zoom"></code>
    точност : <code id="accuracy"></code>&nbsp;&nbsp;

    <!--  Тази функционалност не е прехвърлена -->
    <input id="view_pos_coords" type="checkbox" style="visibility: hidden;"/>

    <!-- <button id="hello">Send text to RN</button> -->
    <!--<button id="clear" disabled="true">Clr</button>-->
    <!--<button id="point" disabled="true">Pnt</button>-->

    <!-- Тази функционалност не е прехвърлена -->
    <input id="track_point" type="checkbox" style="visibility: hidden;"/>
    <!--<label for="track_point">near tr pnt</label>-->
    <button id="epsg" style="display: none;">EPSG</button>

  </div>
  <div id="info" style="display: none;"></div>

<!--
  <div>
    <button id="json" disabled>Send json to RN</button>
  </div>

  <div>
    <button id="event">Emit greeting event to RN</button>
  </div>
-->
  <!--<div>
    <input id="start_tracking" type="checkbox"/>
    <label for="start_tracking">positioning</label>
    <input id="save_track" type="checkbox" disabled="true"/>
    <label for="save_track">save track</label>
  </div>-->
  <!--<div>-->
    <!--<label style="font-weight: bold;" >view: </label>-->

    <!--  Тази функционалност не е прехвърлена
    <input id="view_pos_coords" type="checkbox"/>
    <label for="view_pos_coords">pos-coords</label>
    -->

    <!--<input id="view_corner_coords" type="checkbox"/>
    <label for="view_corner_coords">region</label>
    <label for="view_track">
      <input id="view_track" type="checkbox" disabled="true"/>
	    curr-track
    </label>
    <input id="view_checkpoints" type="checkbox" disabled="true"/>
    <label for="view_checkpoints">pts</label>
    <input id="zoom_treshold" type="checkbox"/>
    <label for="zoom_treshold">ft</label>-->
  <!--</div>
  <div>-->
    <!--
    altitude : <code id="altitude"></code>&nbsp;&nbsp;
    altitude accuracy : <code id="altitudeAccuracy"></code>&nbsp;&nbsp;
    heading : <code id="heading"></code>&nbsp;&nbsp;
    speed : <code id="speed"></code>
    -->
  <!--</div>-->
  <div id="movepoint_overlay"/>
  <div id="onclick_overlay"  class="overlay" style="background-color: white;"/>
  <div id="coordinate_overlay" style="color: blue; background-color: rgba(245,245,220,0.5);"/>
  <div id="topright_overlay" class="overlay" style="border-radius: 10px 0px 10px 10px; color: blue; border-color: blue; background-color: rgba(245,245,220,0.5);"/>
  <div id="bottomleft_overlay" class="overlay" style="color: blue; border-color: blue; background-color: rgba(245,245,220,0.5);"/>

  <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>  -->

  <!-- <script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script> -->
  <script src="openlayers/ol.js"></script>

<script type="text/javascript">/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/ 		}
/******/ 	};
/******/
/******/ 	// define __esModule on exports
/******/ 	__webpack_require__.r = function(exports) {
/******/ 		if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 			Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 		}
/******/ 		Object.defineProperty(exports, '__esModule', { value: true });
/******/ 	};
/******/
/******/ 	// create a fake namespace object
/******/ 	// mode & 1: value is a module id, require it
/******/ 	// mode & 2: merge all properties of value into the ns
/******/ 	// mode & 4: return value when already ns object
/******/ 	// mode & 8|1: behave like require
/******/ 	__webpack_require__.t = function(value, mode) {
/******/ 		if(mode & 1) value = __webpack_require__(value);
/******/ 		if(mode & 8) return value;
/******/ 		if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/ 		var ns = Object.create(null);
/******/ 		__webpack_require__.r(ns);
/******/ 		Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/ 		if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/ 		return ns;
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = "./src/web/index.js");
/******/ })
/************************************************************************/
/******/ ({

/***/ "./node_modules/react-native-webview-messaging/dist/lib.js":
/*!*****************************************************************!*\
  !*** ./node_modules/react-native-webview-messaging/dist/lib.js ***!
  \*****************************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("/* WEBPACK VAR INJECTION */(function(module) {var __WEBPACK_AMD_DEFINE_FACTORY__, __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;var _typeof=typeof Symbol===\"function\"&&typeof(typeof Symbol===\"function\"?Symbol.iterator:\"@@iterator\")===\"symbol\"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol===\"function\"&&obj.constructor===Symbol&&obj!==(typeof Symbol===\"function\"?Symbol.prototype:\"@@prototype\")?\"symbol\":typeof obj;};!function(e,t){\"object\"==( false?undefined:_typeof(exports))&&\"object\"==( false?undefined:_typeof(module))?module.exports=t(): true?!(__WEBPACK_AMD_DEFINE_ARRAY__ = [], __WEBPACK_AMD_DEFINE_FACTORY__ = (t),\n\t\t\t\t__WEBPACK_AMD_DEFINE_RESULT__ = (typeof __WEBPACK_AMD_DEFINE_FACTORY__ === 'function' ?\n\t\t\t\t(__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__)) : __WEBPACK_AMD_DEFINE_FACTORY__),\n\t\t\t\t__WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__)):undefined;}(undefined,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports;}var n={};return t.m=e,t.c=n,t.i=function(e){return e;},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r});},t.n=function(e){var n=e&&e.__esModule?function(){return e.default;}:function(){return e;};return t.d(n,\"a\",n),n;},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t);},t.p=\"\",t(t.s=2);}([function(e,t,n){\"use strict\";Object.defineProperty(t,\"__esModule\",{value:!0});t.RN_MESSAGES_CHANNEL_PREFIX=\"f251c210-e7c9-42fa-bae3-b9352ec3722a\";},function(e,t,n){\"use strict\";function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0;}function i(e){return\"function\"==typeof e;}function s(e){return\"number\"==typeof e;}function o(e){return\"object\"===(void 0===e?\"undefined\":f(e))&&null!==e;}function u(e){return void 0===e;}var f=\"function\"==typeof Symbol&&\"symbol\"==_typeof(typeof Symbol===\"function\"?Symbol.iterator:\"@@iterator\")?function(e){return typeof e===\"undefined\"?\"undefined\":_typeof(e);}:function(e){return e&&\"function\"==typeof Symbol&&e.constructor===Symbol&&e!==(typeof Symbol===\"function\"?Symbol.prototype:\"@@prototype\")?\"symbol\":typeof e===\"undefined\"?\"undefined\":_typeof(e);};e.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!s(e)||e<0||isNaN(e))throw TypeError(\"n must be a positive number\");return this._maxListeners=e,this;},r.prototype.emit=function(e){var t,n,r,s,f,l;if(this._events||(this._events={}),\"error\"===e&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var a=new Error('Uncaught, unspecified \"error\" event. ('+t+\")\");throw a.context=t,a;}if(n=this._events[e],u(n))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),n.apply(this,s);}else if(o(n))for(s=Array.prototype.slice.call(arguments,1),l=n.slice(),r=l.length,f=0;f<r;f++){l[f].apply(this,s);}return!0;},r.prototype.addListener=function(e,t){var n;if(!i(t))throw TypeError(\"listener must be a function\");return this._events||(this._events={}),this._events.newListener&&this.emit(\"newListener\",e,i(t.listener)?t.listener:t),this._events[e]?o(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,o(this._events[e])&&!this._events[e].warned&&(n=u(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error(\"(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.\",this._events[e].length),\"function\"==typeof console.trace&&console.trace()),this;},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function n(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments));}if(!i(t))throw TypeError(\"listener must be a function\");var r=!1;return n.listener=t,this.on(e,n),this;},r.prototype.removeListener=function(e,t){var n,r,s,u;if(!i(t))throw TypeError(\"listener must be a function\");if(!this._events||!this._events[e])return this;if(n=this._events[e],s=n.length,r=-1,n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit(\"removeListener\",e,t);else if(o(n)){for(u=s;u-->0;){if(n[u]===t||n[u].listener&&n[u].listener===t){r=u;break;}}if(r<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit(\"removeListener\",e,t);}return this;},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events){\"removeListener\"!==t&&this.removeAllListeners(t);}return this.removeAllListeners(\"removeListener\"),this._events={},this;}if(n=this._events[e],i(n))this.removeListener(e,n);else if(n)for(;n.length;){this.removeListener(e,n[n.length-1]);}return delete this._events[e],this;},r.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[];},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length;}return 0;},r.listenerCount=function(e,t){return e.listenerCount(t);};},function(e,t,n){\"use strict\";function r(e,t){if(!(e instanceof t))throw new TypeError(\"Cannot call a class as a function\");}function i(e,t){if(!e)throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");return!t||\"object\"!=(typeof t===\"undefined\"?\"undefined\":_typeof(t))&&\"function\"!=typeof t?e:t;}function s(e,t){if(\"function\"!=typeof t&&null!==t)throw new TypeError(\"Super expression must either be null or a function, not \"+(typeof t===\"undefined\"?\"undefined\":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t);}function o(e,t){return JSON.stringify({type:e,payload:t});}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,\"value\"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r);}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t;};}(),f=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,n,r);}if(\"value\"in i)return i.value;var o=i.get;if(void 0!==o)return o.call(r);},l=n(1),a=function(e){return e&&e.__esModule?e:{default:e};}(l),c=n(0),p=function(e){function t(){return r(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));}return s(t,e),u(t,[{key:\"sendJSON\",value:function value(e){window.postMessage(c.RN_MESSAGES_CHANNEL_PREFIX+o(\"json\",e));}},{key:\"send\",value:function value(e){window.postMessage(c.RN_MESSAGES_CHANNEL_PREFIX+o(\"text\",e));}},{key:\"emit\",value:function value(e,n,r){f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),\"emit\",this).call(this,e,n),r||window.postMessage(c.RN_MESSAGES_CHANNEL_PREFIX+JSON.stringify({type:\"event\",meta:{eventName:e},payload:n}));}}]),t;}(a.default);window.RNMessagesChannel=new p(),e.exports=window.RNMessagesChannel;}]);});\n/* WEBPACK VAR INJECTION */}.call(this, __webpack_require__(/*! ./../../webpack/buildin/module.js */ \"./node_modules/webpack/buildin/module.js\")(module)))\n\n//# sourceURL=webpack:///./node_modules/react-native-webview-messaging/dist/lib.js?");

/***/ }),

/***/ "./node_modules/webpack/buildin/module.js":
/*!***********************************!*\
  !*** (webpack)/buildin/module.js ***!
  \***********************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("module.exports=function(module){if(!module.webpackPolyfill){module.deprecate=function(){};module.paths=[];if(!module.children)module.children=[];Object.defineProperty(module,\"loaded\",{enumerable:true,get:function get(){return module.l;}});Object.defineProperty(module,\"id\",{enumerable:true,get:function get(){return module.i;}});module.webpackPolyfill=1;}return module;};\n\n//# sourceURL=webpack:///(webpack)/buildin/module.js?");

/***/ }),

/***/ "./src/web/index.js":
/*!**************************!*\
  !*** ./src/web/index.js ***!
  \**************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("var _reactNativeWebviewMessaging=__webpack_require__(/*! react-native-webview-messaging */ \"./node_modules/react-native-webview-messaging/dist/lib.js\");var _reactNativeWebviewMessaging2=_interopRequireDefault(_reactNativeWebviewMessaging);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var minAccuracy=5;var hitTOLERANCE=1;var tilesZIndex=0;var positionZIndex=2;var areapoligonZIndex=3;var featuresZIndex=4;var expeditiondataZIndex=5;var trackpointZIndex=6;var checkpointZIndex=7;var changeEPSGBtn=document.querySelector('#epsg');var messagesContainer=document.querySelector('#title');messagesContainer.style.display='none';var chbNearestTrackPoint=document.getElementById('track_point');var chbViewPosCoordinates=document.getElementById('view_pos_coords');var accuracyElement=document.getElementById('accuracy');var zoomElement=document.getElementById('zoom');var onClickOverlay=document.getElementById('onclick_overlay');var movePointOverlayElement=document.getElementById('movepoint_overlay');var zoomTreshold=15;var coordSofia=[2601359.913790558,5262826.329090097];var coordType='EPSG-4326';var geolocationStarted=false;var saveInTrack=false;var saveInTrackFABDisabled=true;var viewPoints=false;var viewCurrentTrack=false;var currTrackFABDisabled=true;var zoomTresholdActive=false;var accessToken='';var sourceTopo50K=new ol.source.TileWMS({url:'http://93.152.172.53/wms?t='+accessToken,params:{'LAYERS':'bgtopo50k','TILED':true,'FORMAT':'image/png','TRANSPARENT':false,'MAP':'raster.map'}});var sourceOSM=new ol.source.OSM();_reactNativeWebviewMessaging2.default.on('transferAccessToken',function(data){accessToken=data.payload.accessToken;sourceTopo50K.setUrl('http://93.152.172.53/wms?t='+accessToken);});var coordiatesToString=function coordiatesToString(coords,rows){var coordStr;if(coordType=='EPSG-4326'){var degrees=ol.proj.transform(coords,'EPSG:3857','EPSG:4326');degrees[0]=degrees[0].toFixed(6);degrees[1]=degrees[1].toFixed(6);if(rows===1){coordStr=degrees.toString();}else{coordStr=degrees[0].toString()+'<br>'+degrees[1].toString();}}else{coordStr=ol.coordinate.toStringXY(coords,9);};return coordStr;};function el(id){return document.getElementById(id);};changeEPSGBtn.addEventListener('click',function(){if(coordType=='EPSG-4326'){coordType='EPSG-3857';}else{coordType='EPSG-4326';};});var expeditiondataLayer;var checkpointsLayer;var expeditiondataStyle=new ol.style.Style({image:new ol.style.RegularShape({fill:new ol.style.Fill({color:'green'}),stroke:new ol.style.Stroke({color:'green',width:1}),points:4,radius:3,angle:Math.PI/4})});var checkPointStyle=new ol.style.Style({text:new ol.style.Text({text:'\\uF041',font:'normal 24px \"FontAwesome\"',textBaseline:'bottom',fill:new ol.style.Fill({color:'rgb(255,0,255)'})})});var checkPointStyle2=new ol.style.Style({text:new ol.style.Text({text:'\\uF041',font:'normal 24px \"FontAwesome\"',textBaseline:'bottom',fill:new ol.style.Fill({color:'green'})})});var checkPointStyle3=new ol.style.Style({text:new ol.style.Text({text:'\\uF041',font:'normal 24px \"FontAwesome\"',textBaseline:'bottom',fill:new ol.style.Fill({color:'red'})})});var clearExpedition=function clearExpedition(){if(expeditionAvailable&&expRegVisible){triggerExpeditionRegoinVisibility();}messagesContainer.innerHTML='No expedition selected';expeditionAvailable=false;if(saveInTrack){triggerSaveInTrack();}saveInTrackFABDisabled=true;_reactNativeWebviewMessaging2.default.sendJSON({command:'saveintrack-FAB-state',payload:{isDisabled:saveInTrackFABDisabled}});if(viewCurrentTrack){triggerCurrentTrackLayer();}currTrackFABDisabled=true;_reactNativeWebviewMessaging2.default.sendJSON({command:'currtrack-FAB-state',payload:{currTrackFABState:currTrackFABDisabled}});if(viewPoints){triggerPointsLayer();}map.removeOverlay(onclick_overlay);isOnclickOverlayVisible=false;_reactNativeWebviewMessaging2.default.sendJSON({command:'points-FAB-state',payload:{pointsFABState:true}});map.removeLayer(expeditiondataLayer);map.removeLayer(efLayer);regionCoordinates=[];regionZoom=0;allTracksData=[];allTracksPoints=[];};_reactNativeWebviewMessaging2.default.on('clear-expedition',function(){clearExpedition();_reactNativeWebviewMessaging2.default.sendJSON({command:'clear-expedition-id',payload:{}});});var internetConnection=false;_reactNativeWebviewMessaging2.default.on('internetConnectionChanged',function(connection){internetConnection=connection.internet.available;});_reactNativeWebviewMessaging2.default.on('clear-expedition',function(){clearExpedition();});var bottom_left_overlay=new ol.Overlay({element:el('bottomleft_overlay'),positioning:'bottom-left'});var top_right_overlay=new ol.Overlay({element:el('topright_overlay'),positioning:'top-right'});var areaLayer;var drawArea=function drawArea(ring){var polygon=new ol.geom.Polygon([ring]);var polygonFeature=new ol.Feature(polygon);var polygonSource=new ol.source.Vector();var polygonStyle=new ol.style.Style({stroke:new ol.style.Stroke({color:'rgba(0,0,255,1.0)',width:1}),fill:new ol.style.Fill({color:'rgba(245,245,220,0.2)'})});polygonSource.addFeature(polygonFeature);areaLayer=new ol.layer.Vector({name:'ExpeditionArea',source:polygonSource,style:polygonStyle,zIndex:areapoligonZIndex});map.addLayer(areaLayer);};var createRing=function createRing(cornerCoords){var minx=cornerCoords[0],miny=cornerCoords[1],maxx=cornerCoords[2],maxy=cornerCoords[3];return[[minx,maxy],[minx,miny],[maxx,miny],[maxx,maxy],[minx,maxy]];};var selectedRegionRingCoords;var selectedRegionZoom;function selectRegion(cornerCoords){var ring=createRing(cornerCoords);drawArea(ring);selectedRegionRingCoords=ring;selectedRegionZoom=view.getZoom();}var expRegVisible=true;function triggerExpeditionRegoinVisibility(){expRegVisible=!expRegVisible;if(expRegVisible){drawArea(regionCoordinates);centerRegion();}else{removeLayer(areaLayer);}_reactNativeWebviewMessaging2.default.sendJSON({command:'expreg-layer-visibility-state',payload:{visibilityState:expRegVisible}});}_reactNativeWebviewMessaging2.default.on('triggerExpeditionRegoinVisibility',triggerExpeditionRegoinVisibility);var selRegVisible=false;function triggerSelectedRegoinVisibility(){selRegVisible=!selRegVisible;if(selRegVisible){var extent=map.getView().calculateExtent(map.getSize());selectRegion(extent);var coords;var element;coords=[extent[0],extent[1]];element=bottom_left_overlay.getElement();element.innerHTML=coordiatesToString(coords,1);bottom_left_overlay.setPosition(coords);map.addOverlay(bottom_left_overlay);coords=[extent[2],extent[3]];element=top_right_overlay.getElement();element.innerHTML=coordiatesToString(coords,1);top_right_overlay.setPosition(coords);map.addOverlay(top_right_overlay);}else{map.removeOverlay(bottom_left_overlay);map.removeOverlay(top_right_overlay);removeLayer(areaLayer);}_reactNativeWebviewMessaging2.default.sendJSON({command:'selreg-layer-visibility-state',payload:{visibilityState:selRegVisible}});}_reactNativeWebviewMessaging2.default.on('triggerSelectedRegoinVisibility',triggerSelectedRegoinVisibility);function acceptSelectedRegoin(){_reactNativeWebviewMessaging2.default.sendJSON({command:'save-area-coordinates',payload:{areaCoords:selectedRegionRingCoords,zoom:selectedRegionZoom}});}_reactNativeWebviewMessaging2.default.on('acceptSelectedRegoin',acceptSelectedRegoin);var positionChanged=false;var userBreak;_reactNativeWebviewMessaging2.default.on('createPoint',function(){if(!geolocationStarted){waitForProperGeolocation();triggerGeolocationActivity();userBreak=false;_reactNativeWebviewMessaging2.default.sendJSON({command:'start-progress',payload:{caption:'Waiting for correct GPS location...',indeterminate:true}});}else{if(positionChanged){var coordinates=geolocation.getPosition();var accuracy=geolocation.getAccuracy();openCheckPointForm(coordinates,accuracy);}}});var inProgress;function waitForProperGeolocation(){inProgress=setTimeout(function(){if(!positionChanged){waitForProperGeolocation();return;}var accuracy=0;var coordinates=geolocation.getPosition();positionChanged=false;if(typeof coordinates==='undefined'||coordinates===null){}else{view.setCenter(coordinates);positionFeature.setGeometry(coordinates?new ol.geom.Point(coordinates):null);accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());accuracy=geolocation.getAccuracy();accuracyElement.innerText=accuracy.toFixed(3)+' [m]';accuracy<=minAccuracy?accuracyElement.style.color='black':accuracyElement.style.color='red';}if(accuracy>0&&accuracy<=minAccuracy){clearTimeout(inProgress);_reactNativeWebviewMessaging2.default.sendJSON({command:'stop-progress',payload:{}});openCheckPointForm(coordinates,accuracy);}else{waitForProperGeolocation();}},2000);}var openCheckPointForm=function openCheckPointForm(coordinates,accuracy){var datamode='new';if(!isOnclickOverlayVisible&&chbNearestTrackPoint.checked){var i;var trackPointCoordinates;var x,y,distance=0.0;var minDistance=100000.0;var minTrackLocationIndex;for(i=0;i<trackPoints.length;i++){trackPointCoordinates=trackPoints[i].getGeometry().getCoordinates();x=trackPointCoordinates[0]-coordinates[0];y=trackPointCoordinates[1]-coordinates[1];distance=Math.sqrt(x*x+y*y);if(distance<minDistance){minDistance=distance;minTrackLocationIndex=i;}}coordinates=trackPoints[minTrackLocationIndex].getGeometry().getCoordinates();accuracy=trackPointsAccuracy[minTrackLocationIndex];}var checkPointCoordinates;var checkpointId=-1;for(i=0;i<checkPoints.length;i++){checkPointCoordinates=checkPoints[i].getGeometry().getCoordinates();if(checkPointCoordinates[0]==coordinates[0]&&checkPointCoordinates[1]==coordinates[1]){datamode='edit';checkpointId=i;break;}};_reactNativeWebviewMessaging2.default.sendJSON({command:'execute',payload:{functionName:'pointControl',geolocation:{coordinates:coordinates,accuracy:accuracy},datamode:datamode,checkpointId:checkpointId}});};_reactNativeWebviewMessaging2.default.on('text',function(text){messagesContainer.innerHTML='Received text from RN: '+text;});_reactNativeWebviewMessaging2.default.on('json',function(text){messagesContainer.innerHTML='Received json from RN: '+JSON.stringify(text);});_reactNativeWebviewMessaging2.default.on('greetingFromRN',function(event){messagesContainer.innerHTML='Received \"greetingFromRN\" event: '+JSON.stringify(event);});var initialZoom=10;zoomElement.innerText=initialZoom.toFixed(3);var expeditionAvailable=false;var expeditionName='';var regionCoordinates=[];var regionZoom=0;var allTracksPoints=[];var allTracksData=[];var trackAvailable=false;var trackName='';var trackDate='';var trackPoints=[];var trackPointsAccuracy=[];var checkPoints=[];var efLayer;var efText=new ol.style.Text({text:'\\uF041',font:'normal 24px \"FontAwesome\"',textBaseline:'bottom',fill:new ol.style.Fill({color:'blue'})});var efStyles={'Point':new ol.style.Style({text:efText}),'LineString':new ol.style.Style({stroke:new ol.style.Stroke({color:'blue',width:1})}),'Polygon':new ol.style.Style({stroke:new ol.style.Stroke({color:'blue',lineDash:[4],width:2}),fill:new ol.style.Fill({color:'rgba(0, 0, 255, 0)'})})};var styleFunction=function styleFunction(feature){return efStyles[feature.getGeometry().getType()];};var centerRegion=function centerRegion(){var x0=regionCoordinates[0];var x2=regionCoordinates[2];var center=[(x2[0]+x0[0])/2,(x2[1]+x0[1])/2];view.setCenter(center);};var processExpeditionData=function processExpeditionData(expedition){if(expedition.payload.expeditionId===0){}else{if(geolocationStarted){triggerGeolocationActivity();}removeLayer(trackpointsLayer);trackPoints=[];trackPointsAccuracy=[];trackAvailable=false;if(expRegVisible){removeLayer(areaLayer);}else expRegVisible=true;_reactNativeWebviewMessaging2.default.sendJSON({command:'expreg-layer-visibility-state',payload:{visibilityState:expRegVisible}});expeditionAvailable=true;expeditionName=expedition.payload.expeditionName;messagesContainer.innerHTML=expedition.payload.expeditionName;regionCoordinates=expedition.payload.regionCoords;regionZoom=expedition.payload.regionZoom;allTracksData=expedition.payload.allTracksData;view.setZoom(regionZoom);centerRegion();drawArea(regionCoordinates);var len=expedition.payload.tracks.length;removeLayer(expeditiondataLayer);expeditiondataLayer=new ol.layer.Vector({name:'ExpeditionData'});if(len>0){allTracksPoints=[];var pFeature;var trPoints=[];for(var i=0;i<len;i++){trPoints=expedition.payload.tracks[i];for(var j=0;j<trPoints.length;j++){pFeature=new ol.Feature({geometry:new ol.geom.Point([trPoints[j][0],trPoints[j][1]])});pFeature.setStyle(expeditiondataStyle);allTracksPoints.push(pFeature);};};var expeditiondataSource=new ol.source.Vector({features:allTracksPoints});expeditiondataLayer.setSource(expeditiondataSource);expeditiondataLayer.setZIndex(expeditiondataZIndex);map.addLayer(expeditiondataLayer);};viewPoints=true;removeLayer(checkpointsLayer);checkPoints=[];var point_feature,coords;var silent=true;for(var i=0;i<expedition.payload.checkpoints.length;i++){coords=[expedition.payload.checkpoints[i][0],expedition.payload.checkpoints[i][1]];point_feature=new ol.Feature({geometry:new ol.geom.Point(coords)});point_feature.setStyle(checkPointStyle2);point_feature.setId(i);point_feature.setProperties({editable:true},silent);checkPoints.push(point_feature);};checkpointsLayer=new ol.layer.Vector({name:'ExpeditionCheckpoints'});var source=new ol.source.Vector({features:checkPoints});checkpointsLayer.setSource(source);checkpointsLayer.setZIndex(checkpointZIndex);map.addLayer(checkpointsLayer);_reactNativeWebviewMessaging2.default.sendJSON({command:'points-layer-visibility-state',payload:{visibilityState:viewPoints}});removeLayer(efLayer);var efSource=new ol.source.Vector({features:new ol.format.GeoJSON().readFeatures(expedition.payload.regionFeatures)});efLayer=new ol.layer.Vector({name:'ExpeditionFeatures',source:efSource,style:styleFunction,visible:isFeaturesLayerVisible(view.getZoom())});efLayer.setZIndex(featuresZIndex);map.addLayer(efLayer);_reactNativeWebviewMessaging2.default.sendJSON({command:'points-FAB-state',payload:{pointsFABState:false}});map.removeOverlay(onclick_overlay);isOnclickOverlayVisible=false;};};_reactNativeWebviewMessaging2.default.on('transferExpeditionData',function(expedition){processExpeditionData(expedition);});var partialData={};_reactNativeWebviewMessaging2.default.on('initPartialTransfer',function(data){partialData={dataType:data.payload.dataType,partsCount:data.payload.partsCount,transferedCount:0,dataSlots:[]};for(var i=0;i<data.payload.partsCount;i++){partialData.dataSlots.push('empty');};});_reactNativeWebviewMessaging2.default.on('partialTransfer',function(data){partialData.transferedCount++;partialData.dataSlots[data.payload.ind]=data.payload.partData;var allPartsTransfered=function allPartsTransfered(){var result=true;for(var i=0;i<partialData.partsCount;i++){if(partialData.dataSlots[i]=='empty'){result=false;break;};};return result;};var joinPartialData=function joinPartialData(){return new Promise(function(resolve,reject){resolve(partialData.dataSlots.join(''));});};if(partialData.transferedCount==partialData.partsCount){var timeout=false;setTimeout(function(){timeout=true;},5000);do{var ok=allPartsTransfered();}while(!ok&&!timeout);if(timeout==true){alert('Error in partial data transfer! Remain in previous expedition state.');return;};joinPartialData().then(function(joinedData){if(partialData.dataType=='JSON'){processExpeditionData({payload:JSON.parse(joinedData)});}else{};});};});_reactNativeWebviewMessaging2.default.on('transferTrackData',function(track){saveInTrackFABDisabled=false;_reactNativeWebviewMessaging2.default.sendJSON({command:'saveintrack-FAB-state',payload:{isDisabled:saveInTrackFABDisabled}});currTrackFABDisabled=false;_reactNativeWebviewMessaging2.default.sendJSON({command:'currtrack-FAB-state',payload:{currTrackFABState:currTrackFABDisabled}});viewCurrentTrack=true;_reactNativeWebviewMessaging2.default.sendJSON({command:'currtrack-layer-visibility-state',payload:{visibilityState:viewCurrentTrack}});var i;var trackGeolocationData={};if(track.payload.emptyTrack){var source=expeditiondataLayer.getSource();if(track.payload.delAllTracks){source.clear();allTracksPoints=[];source=new ol.source.Vector({features:allTracksPoints});expeditiondataLayer.setSource(s);}else{var features=source.getFeatures();var tracksCnt=allTracksData.length;var currTrackData;for(i=0;i<tracksCnt;i++){currTrackData=allTracksData[i];if(currTrackData.trackName==trackName){var fpInd,border;fpInd=currTrackData.firstPointIndex;border=fpInd+currTrackData.pointsCount;for(var j=fpInd;j<border;j++){source.removeFeature(allTracksPoints[j],{silent:true});}allTracksPoints.splice(fpInd,currTrackData.pointsCount);break;}}}trackName='-';trackDate='';messagesContainer.innerHTML=expeditionName;}else{trackName=track.payload.trackName;trackDate=track.payload.trackDate;messagesContainer.innerHTML=expeditionName+', '+trackName+' ('+trackDate+')';};_reactNativeWebviewMessaging2.default.sendJSON({command:'set-primary-key',payload:{trackName:trackName,trackDate:trackDate}});trackGeolocationData=track.payload.geoLocations;trackAvailable=!track.payload.emptyTrack;removeLayer(trackpointsLayer);trackPoints=[];trackPointsAccuracy=[];createTrackpointsLayer();var geolocationsCount=Object.keys(trackGeolocationData).length;if(geolocationsCount>0){addPointToTrack(firstPointStyle,[trackGeolocationData[0].coordinates[0],trackGeolocationData[0].coordinates[1]]);trackPointsAccuracy[0]=trackGeolocationData[0].accuracy;}for(i=1;i<geolocationsCount;i++){addPointToTrack(trackPointStyle,[trackGeolocationData[i].coordinates[0],trackGeolocationData[i].coordinates[1]]);trackPointsAccuracy[i]=trackGeolocationData[i].accuracy;};var s=new ol.source.Vector({features:trackPoints});trackpointsLayer.setSource(s);addPointLayer(trackpointsLayer);view.setZoom(regionZoom);if(geolocationsCount>0){if(track.payload.centerAtFirstPoint){view.setCenter([trackGeolocationData[0].coordinates[0],trackGeolocationData[0].coordinates[1]]);};chbNearestTrackPoint.disabled=false;}else{chbNearestTrackPoint.disabled=true;}});_reactNativeWebviewMessaging2.default.on('createCheckpoint',function(payload){if(payload.checkpoint.create){var point_geom=new ol.geom.Point(payload.checkpoint.coordinates);var point_feature=new ol.Feature({geometry:point_geom});point_feature.setStyle(checkPointStyle);point_feature.setId(checkPoints.length);point_feature.setProperties({editable:true},true);checkpointsLayer.getSource().addFeature(point_feature);checkPoints.push(point_feature);if(!viewPoints)triggerPointsLayer();}map.removeOverlay(onclick_overlay);isOnclickOverlayVisible=false;_reactNativeWebviewMessaging2.default.sendJSON({command:'points-FAB-state',payload:{pointsFABState:false}});});_reactNativeWebviewMessaging2.default.on('removeCheckpoint',function(payload){if(payload.checkpoint.remove){var i;var checkPointCoordinates,coordinates;for(i=0;i<checkPoints.length;i++){checkPointCoordinates=checkPoints[i].getGeometry().getCoordinates();coordinates=payload.checkpoint.coordinates;if(checkPointCoordinates[0]==coordinates[0]&&checkPointCoordinates[1]==coordinates[1]){checkpointsLayer.getSource().removeFeature(checkPoints[i],{silent:true});checkPoints.splice(i,1);break;}}}map.removeOverlay(onclick_overlay);isOnclickOverlayVisible=false;_reactNativeWebviewMessaging2.default.sendJSON({command:'points-FAB-state',payload:{pointsFABState:false}});});_reactNativeWebviewMessaging2.default.on('progressEnded',function(payload){clearTimeout(inProgress);accuracyFeature.setGeometry(null);positionFeature.setGeometry(null);});var positionFeature=new ol.Feature();positionFeature.setStyle(new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:'#3399CC'}),stroke:new ol.style.Stroke({color:'#fff',width:2})})}));var trackPointStyle=new ol.style.Style({image:new ol.style.Circle({radius:2,fill:new ol.style.Fill({color:[255,0,255,1]}),stroke:new ol.style.Stroke({color:[255,0,255,1],width:1})}),zIndex:trackpointZIndex});var firstPointStyle=new ol.style.Style({image:new ol.style.Circle({radius:2,fill:new ol.style.Fill({color:[255,255,0,1]}),stroke:new ol.style.Stroke({color:[0,0,255,1],width:1})})});var trackpointsLayer;function createTrackpointsLayer(){trackpointsLayer=new ol.layer.Vector({name:'ExpeditionTracks',source:new ol.source.Vector({features:trackPoints}),zIndex:trackpointZIndex});};var view=new ol.View({center:[0,0],rotation:0,enableRotation:false,zoom:2});view.setZoom(initialZoom);view.setCenter(coordSofia);var getLayerByName=function getLayerByName(layerName){var layer;map.getLayers().forEach(function(l){if(l.get('title')===layerName){layer=l;}});return layer;};var visibleTopo50K=true;_reactNativeWebviewMessaging2.default.on('changeTiles',function(){var layer=getLayerByName('Tiles');if(visibleTopo50K===true){visibleTopo50K=false;layer.setSource(sourceOSM);}else{visibleTopo50K=true;layer.setSource(sourceTopo50K);}});var scaleLineControl=new ol.control.ScaleLine();scaleLineControl.setUnits('metric');var map=new ol.Map({target:'map',renderer:'canvas',layers:[new ol.layer.Tile({title:'Tiles',type:'base',visible:true,preload:Infinity,source:sourceTopo50K,zIndex:tilesZIndex})],controls:ol.control.defaults({attributionOptions:{collapsible:false}}).extend([scaleLineControl]),view:view});var geolocation=new ol.Geolocation({projection:view.getProjection(),tracking:false,trackingOptions:{enableHighAccuracy:true,timeout:Infinity,maximumAge:0}});chbNearestTrackPoint.addEventListener('change',function(){if(this.checked&&isOnclickOverlayVisible&&trackPoints.length>0){var i;var trackPointCoordinates;var x,y,distance=0.0;var minDistance=100000.0;var minTrackLocationIndex;for(i=0;i<trackPoints.length;i++){trackPointCoordinates=trackPoints[i].getGeometry().getCoordinates();x=trackPointCoordinates[0]-onClickOverlayCoordinates[0];y=trackPointCoordinates[1]-onClickOverlayCoordinates[1];distance=Math.sqrt(x*x+y*y);if(distance<minDistance){minDistance=distance;minTrackLocationIndex=i;}}onClickOverlayCoordinates=trackPoints[minTrackLocationIndex].getGeometry().getCoordinates();var element=onclick_overlay.getElement();element.innerHTML=coordiatesToString(onClickOverlayCoordinates,2);onclick_overlay.setPosition(onClickOverlayCoordinates);}});function triggerGeolocationActivity(){geolocationStarted=!geolocationStarted;_reactNativeWebviewMessaging2.default.sendJSON({command:'positioning-FAB-visibility-state',payload:{positioningFABState:geolocationStarted}});if(geolocationStarted){positionChanged=false;removeLayer(trackpointsLayer);createTrackpointsLayer();addPointLayer(trackpointsLayer);_reactNativeWebviewMessaging2.default.sendJSON({command:'set-primary-key',payload:{trackName:trackName,trackDate:trackDate}});_reactNativeWebviewMessaging2.default.sendJSON({command:'disable-button',payload:{buttonName:'TrackControl'}});}else{saveInTrack=false;_reactNativeWebviewMessaging2.default.sendJSON({command:'saveintrack-FAB-visibility-state',payload:{saveInTrackFABState:saveInTrack}});accuracyFeature.setGeometry(null);positionFeature.setGeometry(null);accuracyElement.innerText='';map.removeOverlay(coord_overlay);_reactNativeWebviewMessaging2.default.sendJSON({command:'enable-button',payload:{buttonName:'TrackControl'}});}geolocation.setTracking(geolocationStarted);}_reactNativeWebviewMessaging2.default.on('triggerGeolocationState',triggerGeolocationActivity);function triggerSaveInTrack(){saveInTrack=!saveInTrack;if(!trackAvailable){if(saveInTrack){saveInTrack=false;alert('No track available!');}return;}if(!geolocationStarted){if(saveInTrack){saveInTrack=false;alert('Start geolocation first!');}return;}_reactNativeWebviewMessaging2.default.sendJSON({command:'saveintrack-FAB-visibility-state',payload:{saveInTrackFABState:saveInTrack}});}_reactNativeWebviewMessaging2.default.on('triggerSaveInTrack',triggerSaveInTrack);function triggerCurrentTrackLayer(){viewCurrentTrack=!viewCurrentTrack;if(viewCurrentTrack){addPointLayer(trackpointsLayer);}else{removeLayer(trackpointsLayer);}_reactNativeWebviewMessaging2.default.sendJSON({command:'currtrack-layer-visibility-state',payload:{visibilityState:viewCurrentTrack}});}_reactNativeWebviewMessaging2.default.on('triggerCurrentTrack',triggerCurrentTrackLayer);var triggerPointsLayer=function triggerPointsLayer(){viewPoints=!viewPoints;if(viewPoints){addPointLayer(checkpointsLayer);}else{removeLayer(checkpointsLayer);}_reactNativeWebviewMessaging2.default.sendJSON({command:'points-layer-visibility-state',payload:{visibilityState:viewPoints}});};_reactNativeWebviewMessaging2.default.on('triggerPoints',triggerPointsLayer);_reactNativeWebviewMessaging2.default.on('triggerZoomTreshold',function(){zoomTresholdActive=!zoomTresholdActive;efLayer.setVisible(isFeaturesLayerVisible(view.getZoom()));_reactNativeWebviewMessaging2.default.sendJSON({command:'zoom-treshold-state',payload:{zoomTresholdState:zoomTresholdActive}});});var isOnclickOverlayVisible=false;var isOnclickOverlayReady=true;function allowOnclickOverlay(){isOnclickOverlayReady=true;};var onClickOverlayCoordinates;var clickEvent=null;onClickOverlay.ondblclick=function(evt){if(isOnclickOverlayVisible){clickEvent=null;alert('This is \"dblclick\" event.');};};onClickOverlay.onclick=function(evt){clickEvent=evt;setTimeout(click_action,300);};var click_action=function click_action(){if(clickEvent==null)return;var evt=clickEvent;if(expeditionAvailable&&isOnclickOverlayReady){_reactNativeWebviewMessaging2.default.sendJSON({command:'execute',payload:{functionName:'pointControl',geolocation:{coordinates:onClickOverlayCoordinates,accuracy:0},datamode:'new',checkpointId:-1}});}};onClickOverlay.oncontextmenu=function(evt){alert('This is \"oncontextmenu\" (\"rightclick\") event.');return false;};var overlayDx=null;var overlayDy=null;onClickOverlay.addEventListener('touchstart',function(evt){var enabledTouchendEvent=false;function move(evt){var coords=map.getEventCoordinate(evt);if(overlayDx==null){overlayDx=coords[0]-onClickOverlayCoordinates[0];overlayDy=coords[1]-onClickOverlayCoordinates[1];};coords[0]-=overlayDx;coords[1]-=overlayDy;onClickOverlayCoordinates=coords;var element=onclick_overlay.getElement();element.innerHTML=coordiatesToString(onClickOverlayCoordinates,2);onclick_overlay.setPosition(onClickOverlayCoordinates);enabledTouchendEvent=true;};function end(evt){var e=evt;overlayDx=null;window.removeEventListener('touchmove',move);window.removeEventListener('touchend',end);if(enabledTouchendEvent){isOnclickOverlayReady=true;processMapClick();isOnclickOverlayReady=true;saveMapClickEvent.coordinate=onClickOverlayCoordinates;saveMapClickEvent.pixel=map.getPixelFromCoordinate(onClickOverlayCoordinates);processMapClick(saveMapClickEvent);enabledTouchendEvent=false;}};window.addEventListener('touchmove',move);window.addEventListener('touchend',end);});chbViewPosCoordinates.addEventListener('click',function(){if(!this.checked){map.removeOverlay(coord_overlay);};});geolocation.on('change',function(){positionChanged=true;var accuracy=geolocation.getAccuracy();accuracyElement.innerText=accuracy.toFixed(3)+' [m]';accuracy<=minAccuracy?accuracyElement.style.color='black':accuracyElement.style.color='red';});geolocation.on('error',function(error){var info=document.getElementById('info');info.innerHTML=error.message;info.style.display='';});var accuracyFeature=new ol.Feature();geolocation.on('change:accuracyGeometry',function(){accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());});function addPointToTrack(style,coords){var trackPointFeature=new ol.Feature({geometry:new ol.geom.Point(coords)});trackPointFeature.setStyle(style);trackPoints.push(trackPointFeature);}geolocation.once('change:position',function(){});var coord_overlay=new ol.Overlay({element:el('coordinate_overlay')});var onclick_overlay=new ol.Overlay({element:onClickOverlay,positioning:'top-left'});geolocation.on('change:position',function(){var coordinates=geolocation.getPosition();var accuracy=geolocation.getAccuracy();if(saveInTrack){_reactNativeWebviewMessaging2.default.sendJSON({command:'execute',payload:{functionName:'saveGeolocation',geolocation:{coordinates:coordinates,accuracy:accuracy}}});var point_geom=new ol.geom.Point(coordinates);var point_feature=new ol.Feature({geometry:point_geom});point_feature.setStyle(trackPointStyle);trackpointsLayer.getSource().addFeature(point_feature);trackPoints.push(point_feature);trackPointsAccuracy.push(accuracy);chbNearestTrackPoint.disabled=false;}if(chbViewPosCoordinates.checked){var element=coord_overlay.getElement();element.innerHTML=coordiatesToString(coordinates,2);coord_overlay.setPosition(coordinates);map.addOverlay(coord_overlay);};view.setCenter(coordinates);positionFeature.setGeometry(coordinates?new ol.geom.Point(coordinates):null);});var positionLayer;positionLayer=new ol.layer.Vector({name:'GPSPosition',map:map,source:new ol.source.Vector({features:[accuracyFeature,positionFeature]}),zIndex:positionZIndex});function addPointLayer(points){map.addLayer(points);}function removeLayer(points){map.removeLayer(points);}var movePointId=-1;var movePointFromCoordinates;var movePointToCoordinates;var savedPointStyle;var movePointOverlay=new ol.Overlay({element:movePointOverlayElement,positioning:'top-left'});movePointOverlayElement.addEventListener('touchstart',function(evt){var enabledTouchendEvent=false;var source=checkpointsLayer.getSource();var lineFeature=null;savedPointStyle=checkPoints[movePointId].getStyle();checkPoints[movePointId].setStyle(checkPointStyle3);function move(evt){var coords=map.getEventCoordinate(evt);if(overlayDx==null){overlayDx=coords[0]-movePointToCoordinates[0];overlayDy=coords[1]-movePointToCoordinates[1];};coords[0]-=overlayDx;coords[1]-=overlayDy;movePointToCoordinates=coords;movePointOverlay.setPosition(movePointToCoordinates);if(lineFeature===null){lineFeature=new ol.Feature({id:'Line',geometry:new ol.geom.LineString([movePointFromCoordinates,movePointToCoordinates],'XY')});lineFeature.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:'red',lineDash:[2,4]}),zIndex:checkpointZIndex}));source.addFeature(lineFeature);}else{lineFeature.getGeometry().setCoordinates([movePointFromCoordinates,movePointToCoordinates]);};enabledTouchendEvent=true;};function end(evt){var e=evt;overlayDx=null;window.removeEventListener('touchmove',move);window.removeEventListener('touchend',end);if(enabledTouchendEvent){map.removeOverlay(movePointOverlay);source.removeFeature(lineFeature);source.getFeatureById(movePointId).getGeometry().setCoordinates(movePointToCoordinates);checkPoints[movePointId].setStyle(savedPointStyle);_reactNativeWebviewMessaging2.default.sendJSON({command:'change-point-coordinates',payload:{pointId:movePointId,newCoords:movePointToCoordinates}});movePointId=-1;enabledTouchendEvent=false;}};window.addEventListener('touchmove',move);window.addEventListener('touchend',end);});_reactNativeWebviewMessaging2.default.on('move-point',function(data){movePointOverlayElement.innerHTML='move';movePointId=data.payload.pointId;movePointFromCoordinates=data.payload.coordinates;movePointToCoordinates=movePointFromCoordinates;movePointOverlay.setPosition(movePointToCoordinates);map.addOverlay(movePointOverlay);});var modeSelectRegion=false;_reactNativeWebviewMessaging2.default.on('setModeSelectRegion',function(obj){modeSelectRegion=obj.payload.modeState;});var processMapClick=function processMapClick(event){if(movePointId>=0){map.removeOverlay(movePointOverlay);checkPoints[movePointId].setStyle(savedPointStyle);movePointId=-1;}if(isOnclickOverlayReady){isOnclickOverlayReady=false;if(isOnclickOverlayVisible){isOnclickOverlayVisible=false;map.removeOverlay(onclick_overlay);_reactNativeWebviewMessaging2.default.sendJSON({command:'points-FAB-state',payload:{pointsFABState:false}});}else{isOnclickOverlayVisible=true;var coords=event.coordinate;var accuracy=0;var i;if(chbNearestTrackPoint.checked){var trackPointCoordinates;var x,y,distance=0.0;var minDist=100000.0;var minTrackLocationIndex;for(i=0;i<trackPoints.length;i++){trackPointCoordinates=trackPoints[i].getGeometry().getCoordinates();x=trackPointCoordinates[0]-coords[0];y=trackPointCoordinates[1]-coords[1];distance=Math.sqrt(x*x+y*y);if(distance<minDist){minDist=distance;minTrackLocationIndex=i;}}coords=trackPoints[minTrackLocationIndex].getGeometry().getCoordinates();accuracy=trackPointsAccuracy[minTrackLocationIndex];}onClickOverlayCoordinates=coords;var found=false;var layerFilter=function layerFilter(layer){var layerName=layer.get('name');return layerName=='ExpeditionData'||layerName=='ExpeditionCheckpoints'||layerName=='ExpeditionTracks'||layerName=='ExpeditionFeatures';};var features=map.getFeaturesAtPixel(event.pixel,{layerFilter:layerFilter,hitTolerance:hitTOLERANCE});var featuresAtPixel={'pixel':event.pixel,'features':[]};if(features!=undefined){features.map(function(featureAtPixel){var obj={};obj.type=featureAtPixel.getGeometry().getType();try{obj.id=featureAtPixel.getId();}catch(e){};if(obj.id!=undefined){var isEditable=featureAtPixel.getProperties().editable==true;if(!found&&obj.type=='Point'&&isEditable){found=true;obj.coordinates=featureAtPixel.getGeometry().getCoordinates();_reactNativeWebviewMessaging2.default.sendJSON({command:'execute',payload:{functionName:'pointControl',geolocation:{coordinates:obj.coordinates,accuracy:accuracy},datamode:'edit',checkpointId:obj.id}});};var isFeature=!isEditable;if(isFeature){featuresAtPixel.features.push(obj);};};});};if(!found){var fLen=featuresAtPixel.features.length;if(fLen>0){if(fLen==1){_reactNativeWebviewMessaging2.default.sendJSON({command:'execute',payload:{functionName:'featureInfo',featureId:featuresAtPixel.features[0].id}});}else{_reactNativeWebviewMessaging2.default.sendJSON({command:'execute',payload:{functionName:'featureMenu',features:featuresAtPixel}});};};var element=onclick_overlay.getElement();element.innerHTML=coordiatesToString(coords,2);onclick_overlay.setPosition(coords);map.addOverlay(onclick_overlay);_reactNativeWebviewMessaging2.default.sendJSON({command:'points-FAB-state',payload:{pointsFABState:true}});}}setTimeout(allowOnclickOverlay,700);}};var saveMapClickEvent;map.on('click',function(event){if(modeSelectRegion===true)return;saveMapClickEvent=event;processMapClick(event);});function onMoveEnd(evt){if(internetConnection==true&&view.getZoom()>=18){var extent=view.calculateExtent(map.getSize());var ring=createRing(extent);_reactNativeWebviewMessaging2.default.sendJSON({command:'extent-changed',payload:{ring:ring}});}};map.on('moveend',onMoveEnd);function isFeaturesLayerVisible(zoom){return zoomTresholdActive||zoom>=zoomTreshold;};view.on('change:resolution',function(){var zoom=view.getZoom();zoomElement.innerText=zoom.toFixed(3);if(efLayer!=undefined){efLayer.setVisible(isFeaturesLayerVisible(zoom));};});\n\n//# sourceURL=webpack:///./src/web/index.js?");

/***/ })

/******/ });</script></body>
</html>
