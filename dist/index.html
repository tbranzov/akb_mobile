<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    body {
		text-align: center;
    }
	.overlay {
		border: 1px solid black;
		border-radius: 10px 10px 10px 0px;
		padding: 5px 10px;
	}
  </style>

  <!-- <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css"> -->
  <link rel="stylesheet" href="openlayers/ol.css" type="text/css">

  <link rel="stylesheet" href="geolocation-style.css" type="text/css">

</head>
<body>
  <p>No expedition selected</p>
  <div>
    <!-- <button id="hello">Send text to RN</button> -->
    <button id="clear" disabled="true">Clear</button>
    <button id="point" disabled="true">Point</button>
    <input id="track_point" type="checkbox" disabled="true"/>
    <label for="track_point">nearest track point</label>
    <button id="close_overlay" disabled>Close Overlay</button>
  </div>
<!--
  <div>
    <button id="json" disabled>Send json to RN</button>
  </div>

  <div>
    <button id="event">Emit greeting event to RN</button>
  </div>
-->
  <div id="map" class="map"></div>
  <div id="info" style="display: none;"></div>
  <div>
    <input id="start_tracking" type="checkbox"/>
    <label for="start_tracking">positioning</label>
    <input id="save_track" type="checkbox" disabled="true"/>
    <label for="save_track">save track</label>
  </div>
  <div>
    <label style="font-weight: bold;" >view: </label>
    <input id="view_pos_coords" type="checkbox"/>
    <label for="view_pos_coords">pos-coords</label>
    <input id="view_corner_coords" type="checkbox"/>
    <label for="view_corner_coords">region</label>
    <label for="view_track">
      <input id="view_track" type="checkbox" disabled="true"/>
	  current track
	</label>
    <input id="view_checkpoints" type="checkbox" disabled="true"/>
    <label for="view_checkpoints">check-pts</label>
  </div>
  <div>
    position accuracy : <code id="accuracy"></code>&nbsp;&nbsp;
<!--
    altitude : <code id="altitude"></code>&nbsp;&nbsp;
    altitude accuracy : <code id="altitudeAccuracy"></code>&nbsp;&nbsp;
    heading : <code id="heading"></code>&nbsp;&nbsp;
    speed : <code id="speed"></code>
-->
	zoom : <code id="zoom"></code>
  </div>
  <div id="onclick_overlay"  class="overlay" style="background-color: white;"/>
  <div id="coordinate-overlay"/>
  <div id="toprightoverlay" class="overlay" style="border-radius: 10px 0px 10px 10px;"/>
  <div id="bottomleftoverlay" class="overlay"/>

  <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>  -->
    
  <!-- <script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script> -->
  <script src="openlayers/ol.js"></script>
  
<script type="text/javascript">!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=2)}([function(e,t,o){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,o){"use strict";(function(e){var o,n,r,i,a="function"==typeof Symbol&&"symbol"==typeof("function"==typeof Symbol?Symbol.iterator:"@@iterator")?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==("function"==typeof Symbol?Symbol.prototype:"@@prototype")?"symbol":typeof e};i=function(){return function(e){function t(n){if(o[n])return o[n].exports;var r=o[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var o={};return t.m=e,t.c=o,t.i=function(e){return e},t.d=function(e,o,n){t.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(e,t,o){Object.defineProperty(t,"__esModule",{value:!0}),t.RN_MESSAGES_CHANNEL_PREFIX="f251c210-e7c9-42fa-bae3-b9352ec3722a"},function(e,t,o){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function i(e){return"object"===(void 0===e?"undefined":s(e))&&null!==e}function l(e){return void 0===e}var s="function"==typeof Symbol&&"symbol"==a("function"==typeof Symbol?Symbol.iterator:"@@iterator")?function(e){return void 0===e?"undefined":a(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==("function"==typeof Symbol?Symbol.prototype:"@@prototype")?"symbol":void 0===e?"undefined":a(e)};e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if(!function(e){return"number"==typeof e}(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,o,n,a,s,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var d=new Error('Uncaught, unspecified "error" event. ('+t+")");throw d.context=t,d}if(l(o=this._events[e]))return!1;if(r(o))switch(arguments.length){case 1:o.call(this);break;case 2:o.call(this,arguments[1]);break;case 3:o.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),o.apply(this,a)}else if(i(o))for(a=Array.prototype.slice.call(arguments,1),n=(c=o.slice()).length,s=0;s<n;s++)c[s].apply(this,a);return!0},n.prototype.addListener=function(e,t){var o;if(!r(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?i(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,i(this._events[e])&&!this._events[e].warned&&(o=l(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){function o(){this.removeListener(e,o),n||(n=!0,t.apply(this,arguments))}if(!r(t))throw TypeError("listener must be a function");var n=!1;return o.listener=t,this.on(e,o),this},n.prototype.removeListener=function(e,t){var o,n,a,l;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(a=(o=this._events[e]).length,n=-1,o===t||r(o.listener)&&o.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(i(o)){for(l=a;l-- >0;)if(o[l]===t||o[l].listener&&o[l].listener===t){n=l;break}if(n<0)return this;1===o.length?(o.length=0,delete this._events[e]):o.splice(n,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,o;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r(o=this._events[e]))this.removeListener(e,o);else if(o)for(;o.length;)this.removeListener(e,o[o.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){return this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(r(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,o){function n(e,t){return JSON.stringify({type:e,payload:t})}var r=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(o(1)),l=o(0),s=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":a(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":a(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),r(t,[{key:"sendJSON",value:function(e){window.postMessage(l.RN_MESSAGES_CHANNEL_PREFIX+n("json",e))}},{key:"send",value:function(e){window.postMessage(l.RN_MESSAGES_CHANNEL_PREFIX+n("text",e))}},{key:"emit",value:function(e,o,n){(function e(t,o,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,o);if(void 0===r){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,o,n)}if("value"in r)return r.value;var a=r.get;return void 0!==a?a.call(n):void 0})(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"emit",this).call(this,e,o),n||window.postMessage(l.RN_MESSAGES_CHANNEL_PREFIX+JSON.stringify({type:"event",meta:{eventName:e},payload:o}))}}]),t}();window.RNMessagesChannel=new s,e.exports=window.RNMessagesChannel}])},"object"==a(t)&&"object"==a(e)?e.exports=i():(n=[],void 0===(r="function"==typeof(o=i)?o.apply(t,n):o)||(e.exports=r))}).call(this,o(0)(e))},function(e,t,o){"use strict";var n,r=o(1),i=(n=r)&&n.__esModule?n:{default:n};var a,l,s=25,c=4,d=document.querySelector("#clear"),u=document.querySelector("#point"),f=document.querySelector("#close_overlay"),y=document.querySelector("p"),p=document.getElementById("start_tracking"),m=document.getElementById("track_point"),v=document.getElementById("view_pos_coords"),h=document.getElementById("view_corner_coords"),g=document.getElementById("save_track"),b=document.getElementById("view_track"),w=document.getElementById("view_checkpoints"),k=document.getElementById("accuracy"),_=document.getElementById("onclick_overlay");function S(e){return document.getElementById(e)}var O=new ol.style.Style({image:new ol.style.RegularShape({fill:new ol.style.Fill({color:"blue"}),stroke:new ol.style.Stroke({color:"blue",width:1}),points:4,radius:3,angle:Math.PI/4})}),L=new ol.style.Style({image:new ol.style.RegularShape({radius:10,radius2:4,points:5,angle:0,fill:new ol.style.Fill({color:"red"}),stroke:new ol.style.Stroke({color:"blue",width:1})})}),E=new ol.style.Style({image:new ol.style.RegularShape({radius:10,radius2:4,points:5,angle:0,fill:new ol.style.Fill({color:"blue"}),stroke:new ol.style.Stroke({color:"blue",width:1})})}),x=function(){I&&h.checked&&h.click(),y.innerHTML="No expedition selected",I=!1,g.checked&&g.click(),g.disabled=!0,b.checked&&b.click(),b.disabled=!0,w.checked&&w.click(),w.disabled=!0,$.removeOverlay(se),oe=!1,f.disabled=!0,u.disabled=!0,$.removeLayer(a),R=[],H=0,V=[],J=[],d.disabled=!0};d.addEventListener("click",function(){x(),i.default.sendJSON({command:"clear-expedition",payload:{}})}),i.default.on("clear-expedition",function(){x()});var N,P=new ol.Overlay({element:S("bottomleftoverlay"),positioning:"bottom-left"}),M=new ol.Overlay({element:S("toprightoverlay"),positioning:"top-right"}),C=function(e){var t=new ol.geom.Polygon([e]),o=new ol.Feature(t),n=new ol.source.Vector;n.addFeature(o),N=new ol.layer.Vector({source:n,zIndex:2}),$.addLayer(N)},T=!1;h.addEventListener("click",function(){if(T)de(N),I||($.removeOverlay(M),$.removeOverlay(P),i.default.sendJSON({command:"save-area-coordinates",payload:{areaCoords:[]}}));else if(I)C(R);else{var e,t,o=$.getView().calculateExtent($.getSize());e=[o[0],o[1]],t="lon: "+o[0].toString()+"<br>lat: "+o[1].toString(),P.getElement().innerHTML=t,P.setPosition(e),$.addOverlay(P),e=[o[2],o[3]],t="lon: "+o[2].toString()+"<br>lat: "+o[3].toString(),M.getElement().innerHTML=t,M.setPosition(e),$.addOverlay(M),r=(n=o)[0],a=n[1],l=n[2],s=n[3],C(c=[[r,s],[r,a],[l,a],[l,s],[r,s]]),i.default.sendJSON({command:"save-area-coordinates",payload:{areaCoords:c,zoom:$.getView().getZoom()}})}var n,r,a,l,s,c;T=!T}),f.addEventListener("click",function(){oe=!1,$.removeOverlay(se),f.disabled=!0,u.disabled=!1});var j,F=!1;u.addEventListener("click",function(){if(p.checked){if(F){var e=ee.getPosition(),t=ee.getAccuracy();G(e,t)}}else!function e(){j=setTimeout(function(){if(F){var t=0,o=ee.getPosition();F=!1,void 0===o||null===o||(Q.setCenter(o),D.setGeometry(o?new ol.geom.Point(o):null),ie.setGeometry(ee.getAccuracyGeometry()),t=ee.getAccuracy(),k.innerText=t+" [m]",k.style.color=t<=s?"black":"red"),t>0&&t<=s?(clearTimeout(j),i.default.sendJSON({command:"stop-progress",payload:{}}),G(o,t)):e()}else e()},2e3)}(),p.click(),!1,i.default.sendJSON({command:"start-progress",payload:{indeterminate:!0,caption:"Waiting for correct GPS location..."}})});var G=function(e,t){var o,n="new";if(!oe&&m.checked){var r,a,l,s,c,d=0,u=1e5;for(r=0;r<q.length;r++)l=(a=q[r].getGeometry().getCoordinates())[0]-e[0],s=a[1]-e[1],(d=Math.sqrt(l*l+s*s))<u&&(u=d,c=r);e=q[c].getGeometry().getCoordinates(),t=z[c]}var f=-1;for(r=0;r<X.length;r++)if((o=X[r].getGeometry().getCoordinates())[0]==e[0]&&o[1]==e[1]){n="edit",f=r;break}i.default.sendJSON({command:"execute",payload:{functionName:"pointControl",geolocation:{coordinates:e,accuracy:t},datamode:n,checkpointId:f}})};i.default.on("text",function(e){y.innerHTML="Received text from RN: "+e}),i.default.on("json",function(e){y.innerHTML="Received json from RN: "+JSON.stringify(e)}),i.default.on("greetingFromRN",function(e){y.innerHTML='Received "greetingFromRN" event: '+JSON.stringify(e)});var I=!1,A="",R=[],H=0,J=[],V=[],B=!1,q=[],z=[],Z="",X=[];i.default.on("transferExpeditionData",function(e){if(0==e.payload.expeditionId);else{p.checked&&p.click(),de(Y),q=[],z=[],B=!1,h.checked&&h.click(),h.checked=!0,I=!0,A=e.payload.expeditionName,y.innerHTML=e.payload.expeditionName,R=e.payload.regionCoords,H=e.payload.regionZoom,V=e.payload.allTracksData,Q.setZoom(H);var t=R[0],o=R[2],n=[(o[0]+t[0])/2,(o[1]+t[1])/2];Q.setCenter(n),C(R),T=!0;var r,i,s=e.payload.tracks.length;if(de(a),a=new ol.layer.Vector,s>0){var c;J=[];for(var f=[],m=0;m<s;m++){f=e.payload.tracks[m];for(var v=0;v<f.length;v++)(c=new ol.Feature({geometry:new ol.geom.Point([f[v][0],f[v][1]])})).setStyle(O),J.push(c)}var g=new ol.source.Vector({features:J});a.setSource(g),a.setZIndex(3),$.addLayer(a)}w.disabled=!1,w.checked=!0,de(l),X=[];for(m=0;m<e.payload.checkpoints.length;m++)i=[e.payload.checkpoints[m][0],e.payload.checkpoints[m][1]],(r=new ol.Feature({geometry:new ol.geom.Point(i)})).setStyle(E),X.push(r);l=new ol.layer.Vector;var b=new ol.source.Vector({features:X});l.setSource(b),l.setZIndex(5),$.addLayer(l),d.disabled=!1,u.disabled=!1}}),i.default.on("transferTrackData",function(e){var t;g.disabled=!1,b.disabled=!1,b.checked=!0;var o;if(e.payload.emptyTrack){var n=a.getSource();if(e.payload.delAllTracks)n.clear(),J=[],n=new ol.source.Vector({features:J}),a.setSource(u);else{n.getFeatures();var r,i=V.length;for(t=0;t<i;t++)if((r=V[t]).trackName==Z){var l,s;s=(l=r.firstPointIndex)+r.pointsCount;for(var c=l;c<s;c++)n.removeFeature(J[c],{silent:!0});J.splice(l,r.pointsCount);break}}Z="",y.innerHTML=A}else Z=e.payload.trackName,y.innerHTML=A+", "+Z+" ("+e.payload.trackDate+")";o=e.payload.geoLocations,B=!e.payload.emptyTrack,de(Y),q=[],z=[],K();var d=Object.keys(o).length;for(d>0&&(ae(W,[o[0].coordinates[0],o[0].coordinates[1]]),z[0]=o[0].accuracy),t=1;t<d;t++)ae(U,[o[t].coordinates[0],o[t].coordinates[1]]),z[t]=o[t].accuracy;var u=new ol.source.Vector({features:q});Y.setSource(u),ce(Y),Q.setZoom(H),d>0?(e.payload.centerAtFirstPoint&&Q.setCenter([o[0].coordinates[0],o[0].coordinates[1]]),m.disabled=!1):m.disabled=!0}),i.default.on("createCheckpoint",function(e){if(e.checkpoint.create){var t=new ol.geom.Point(e.checkpoint.coordinates),o=new ol.Feature({geometry:t});o.setStyle(L),l.getSource().addFeature(o),X.push(o)}$.removeOverlay(se),oe=!1,f.disabled=!0,u.disabled=!1}),i.default.on("removeCheckpoint",function(e){var t,o,n;if(e.checkpoint.remove)for(t=0;t<X.length;t++)if(o=X[t].getGeometry().getCoordinates(),n=e.checkpoint.coordinates,o[0]==n[0]&&o[1]==n[1]){l.getSource().removeFeature(X[t],{silent:!0}),X.splice(t,1);break}$.removeOverlay(se),oe=!1,f.disabled=!0,u.disabled=!1}),i.default.on("progressEnded",function(e){clearTimeout(j),ie.setGeometry(null),D.setGeometry(null)});var D=new ol.Feature;D.setStyle(new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#3399CC"}),stroke:new ol.style.Stroke({color:"#fff",width:2})})}));var Y,U=new ol.style.Style({image:new ol.style.Circle({radius:2,fill:new ol.style.Fill({color:[255,0,0,1]}),stroke:new ol.style.Stroke({color:[255,0,0,1],width:1})}),zIndex:c}),W=new ol.style.Style({image:new ol.style.Circle({radius:2,fill:new ol.style.Fill({color:[255,255,0,1]}),stroke:new ol.style.Stroke({color:[0,0,255,1],width:1})})});function K(){Y=new ol.layer.Vector({source:new ol.source.Vector({features:q}),zIndex:c})}var Q=new ol.View({center:[0,0],rotation:0,enableRotation:!1,zoom:2}),$=new ol.Map({target:"map",renderer:"canvas",layers:[new ol.layer.Tile({source:new ol.source.OSM})],controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:Q}),ee=new ol.Geolocation({projection:Q.getProjection(),tracking:!1,trackingOptions:{enableHighAccuracy:!0,timeout:1/0,maximumAge:0}});m.addEventListener("change",function(){if(this.checked&&oe&&q.length>0){var e,t,o,n,r,i=0,a=1e5;for(e=0;e<q.length;e++)o=(t=q[e].getGeometry().getCoordinates())[0]-te[0],n=t[1]-te[1],(i=Math.sqrt(o*o+n*n))<a&&(a=i,r=e);te=q[r].getGeometry().getCoordinates();var l=ol.coordinate.toStringXY(te,9);se.getElement().innerHTML=l,se.setPosition(te)}}),p.addEventListener("change",function(){this.checked?(F=!1,de(Y),K(),ce(Y),i.default.sendJSON({command:"set-primary-key",payload:{trackName:Z}}),i.default.sendJSON({command:"disable-button",payload:{buttonName:"TrackControl"}})):(g.checked=!1,ie.setGeometry(null),D.setGeometry(null),k.innerText="",$.removeOverlay(le),i.default.sendJSON({command:"enable-button",payload:{buttonName:"TrackControl"}})),ee.setTracking(this.checked)}),g.addEventListener("change",function(){B?p.checked||this.checked&&(this.checked=!1,alert("Start geolocation first!")):this.checked&&(this.checked=!1,alert("No track available!"))}),b.addEventListener("change",function(){this.checked?ce(Y):de(Y)}),w.addEventListener("change",function(){this.checked?ce(l):de(l)});var te,oe=!1,ne=!0;function re(){ne=!0}_.addEventListener("click",function(){I&&ne&&i.default.sendJSON({command:"execute",payload:{functionName:"pointControl",geolocation:{coordinates:te,accuracy:0},datamode:"new",checkpointId:-1}})}),v.addEventListener("click",function(){this.checked||$.removeOverlay(le)}),ee.on("change",function(){F=!0;var e=ee.getAccuracy();k.innerText=e+" [m]",k.style.color=e<=s?"black":"red"}),ee.on("error",function(e){var t=document.getElementById("info");t.innerHTML=e.message,t.style.display=""});var ie=new ol.Feature;function ae(e,t){var o=new ol.Feature({geometry:new ol.geom.Point(t)});o.setStyle(e),q.push(o)}ee.on("change:accuracyGeometry",function(){ie.setGeometry(ee.getAccuracyGeometry())}),ee.once("change:position",function(){Q.setZoom(19)});var le=new ol.Overlay({element:S("coordinate-overlay")}),se=new ol.Overlay({element:_,positioning:"bottom-left"});function ce(e){$.addLayer(e)}function de(e){$.removeLayer(e)}ee.on("change:position",function(){var e=ee.getPosition(),t=ee.getAccuracy();if(g.checked){i.default.sendJSON({command:"execute",payload:{functionName:"saveGeolocation",geolocation:{coordinates:e,accuracy:t}}});var o=new ol.geom.Point(e),n=new ol.Feature({geometry:o});n.setStyle(U),Y.getSource().addFeature(n),q.push(n),z.push(t),m.disabled=!1}if(v.checked){var r=ol.coordinate.toStringXY(e,9);le.getElement().innerHTML=r,le.setPosition(e),$.addOverlay(le)}Q.setCenter(e),D.setGeometry(e?new ol.geom.Point(e):null)}),new ol.layer.Vector({map:$,source:new ol.source.Vector({features:[ie,D]}),zIndex:1}),$.on("click",function(e){if(ne){if(ne=!1,oe)oe=!1,$.removeOverlay(se),f.disabled=!0,u.disabled=!1;else{oe=!0;var t,o=e.coordinate,n=0,r=5;if(m.checked){var a,l,s=0,c=1e5;for(t=0;t<q.length;t++)p=(a=q[t].getGeometry().getCoordinates())[0]-o[0],v=a[1]-o[1],(s=Math.sqrt(p*p+v*v))<c&&(c=s,l=t);o=q[l].getGeometry().getCoordinates(),n=z[l],r=0}te=o;var d=!1;if(X.length>0){var y,p,v;s=0;for(t=X.length-1;t>=0;t--)if(p=(y=X[t].getGeometry().getCoordinates())[0]-o[0],v=y[1]-o[1],(s=Math.sqrt(p*p+v*v))<=r){d=!0,i.default.sendJSON({command:"execute",payload:{functionName:"pointControl",geolocation:{coordinates:y,accuracy:n},datamode:"edit",checkpointId:t}});break}}if(!d){var h=ol.coordinate.toStringXY(o,9);se.getElement().innerHTML=h,se.setPosition(o),$.addOverlay(se),f.disabled=!1,u.disabled=!0}}setTimeout(re,700)}}),$.getView().on("change:resolution",function(){S("zoom").innerText=$.getView().getZoom()})}]);</script></body>
</html>
